
name: helm setup and deployment
on:
  workflow_dispatch:
    inputs:
      is_workflow_dispatch:
        description: keep as 1
        type: number
        required: true
        default: 1
jobs:
  test:
    runs-on: ubuntu-latest
    env:
      DOCKER_BUILDKIT: 1
    steps:
      - uses: actions/checkout@v2
      - name: envvars
        #TODO PR_NUMBER: wat - https://github.com/actions/checkout/issues/58
        run: |
          echo "SERVICE_PRINCIPAL_NAME=${{ secrets.SERVICE_PRINCIPAL_NAME  }}" >> $GITHUB_ENV
          echo "CLIENT_SECRET=${{ secrets.CLIENT_SECRET }}" >> $GITHUB_ENV
          echo "TENANT_ID=${{ secrets.TENANT_ID }}" >> $GITHUB_ENV
          echo "ACR_NAME=${{ secrets.ACR_NAME }}" >> $GITHUB_ENV
          echo "AZSUBSCRIPTION=${{ secrets.AZSUBSCRIPTION }}" >> $GITHUB_ENV
          echo "CONTAINER_REGISTRY_NAME=${{ secrets.CONTAINER_REGISTRY_NAME }}" >> $GITHUB_ENV
          echo "MULTINODE=${{ secrets.MULTINODE }}" >> $GITHUB_ENV
          echo "TLS=${{ secrets.TLS }}" >> $GITHUB_ENV
          echo "APP_TAG=${{ secrets.APP_TAG }}" >> $GITHUB_ENV

## docker compose build
      - name: Build the cluster
        run: docker-compose -f dev-compose/docker-compose.yml build


      - name: setup the cluster
        run:  docker-compose -f dev-compose/docker-compose.yml up cluster-setup
##needs to run only once 


      - name: create cluster secrets
        run:  docker-compose -f dev-compose/docker-compose.yml up make-cluster-secrets  
# needs to only run once

# deploy cluster
      - name: deploy the cluster
        run: docker-compose -f dev-compose/docker-compose.yml up helm-docker 