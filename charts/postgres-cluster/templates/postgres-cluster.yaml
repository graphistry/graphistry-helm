apiVersion: postgres-operator.crunchydata.com/v1beta1
kind: PostgresCluster
metadata:
  name: {{.Values.global.postgres.host }}
spec:
  metadata:
    labels:
      app: postgres
  #{{ if eq .Values.global.devMode false }}
  #image: {{.Values.global.containerregistry.name}}/{{.Values.global.graphistry}}:{{.Values.global.postgres.repository}}-{{.Values.global.tag}}-universal
  #{{ else }}  
  #image: graphistry/{{.Values.global.postgres.repository}}:{{.Values.global.tag}}-universal-dev
  #{{ end }}    
  image: registry.developers.crunchydata.com/crunchydata/crunchy-postgres:ubi8-14.5-1
  port: {{ .Values.global.postgres.port }}
  postgresVersion: 14
  users:
    - name: {{.Values.global.postgres.user }}
      databases:
        - {{.Values.global.postgres.name }}
      options: "REPLICATION"
  instances:
    - name: instance1
      replicas: 1
      dataVolumeClaimSpec:
      {{- if eq .Values.global.multiNode true  }}
        accessModes:
          - "ReadWriteMany"
        storageClassName: postgres-longhorn-{{ .Release.Namespace }}
      {{- else }}
        accessModes:
          - "ReadWriteOnce"
        storageClassName: retain-sc-{{ .Release.Namespace }}
      {{- end }}
        resources:
          requests:
            storage: 4Gi   
  patroni:
    dynamicConfiguration:
      postgresql:
        pg_hba:
          - "host all all 0.0.0.0/0 trust" # this line enabled logical replication with programmatic access
          - "host all postgres 127.0.0.1/32 md5"
  
  backups:
    pgbackrest:
      image: registry.developers.crunchydata.com/crunchydata/crunchy-pgbackrest:ubi8-2.40-1
      repos:
        - name: repo1
          volume:
            volumeClaimSpec:
            {{- if eq .Values.global.multiNode true  }}
              accessModes:
                - "ReadWriteMany"
              storageClassName: postgres-longhorn-{{ .Release.Namespace }}
            {{- else }}
              accessModes:
                - "ReadWriteOnce"
              storageClassName: retain-sc-{{ .Release.Namespace }}
            {{- end }}
              resources:
                requests:
                  storage: 4Gi
  imagePullPolicy: {{ .Values.global.imagePullPolicy | quote }}
  {{- with .Values.global.imagePullSecrets }}
  imagePullSecrets:
    {{- toYaml . | nindent 3 }}
  {{- end }}
#  imagePullSecrets:
#    - name: {{ .Values.global.imagePullSecrets  }}


