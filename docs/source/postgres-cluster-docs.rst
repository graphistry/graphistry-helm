.. This page has been autogenerated using Frigate.
   https://frigate.readthedocs.io

Postgrescluster
======================

A postgres cluster Helm chart for Graphistry on Kubernetes

Install Postgres Cluster
-------------------------
**NOTE:** This chart requires the Postgres Operator to be installed. See :doc:`postgres-operator-docs` for information on how to install the Postgres Operator.

  .. tabs::

    .. tab:: Local from Source
      .. code-block:: shell-session            
                
        git clone https://github.com/graphistry/graphistry-helm && cd graphistry-helm
        helm upgrade -i  postgres-cluster ./charts/postgres-cluster --namespace graphistry --create-namespace 

    .. tab:: From Graphistry Helm Repo
      .. code-block:: shell-session            
                
        helm repo add graphistry-helm https://graphistry.github.io/graphistry-helm/
        helm upgrade -i postgrescluster graphistry-helm/postgres-cluster --namespace graphistry --create-namespace  


Configuring Postgres Cluster
----------------------------

After Cluster is deployed, find the pv that is created and add the following label to it. This will allow the cluster to bind the pv to the pod upon redeployment.
      
    .. code-block:: shell-session


      kubectl get pv -n graphistry && kubectl label pv <pv name for the postgres instance> pgo-postgres-cluster=graphistry-postgres        

Change the postgres password if needed. The default password is randomly generated AlphaNumeric string.

    .. code-block:: shell-session


      kubectl patch secret -n postgres-operator postgres-pguser-graphistry -p '{"stringData":{"password":"<password>","verifier":""}}'


Configuration
-------------

The following table lists the configurable parameters of the Postgrescluster chart and their default values.

================================================== ==================================================================================================== ==================================================
Parameter                                          Description                                                                                          Default
================================================== ==================================================================================================== ==================================================
``global.provisioner``                             storage class provisioner                                                                            ``"kubernetes.io/aws-ebs"``                       
``global.multiNode``                               multinode selector switch to determine if going multi/single node                                    ``false``                                         
``global.containerregistry.name``                                                                                                                       ``"acrgraphistryk8s.azurecr.io"``                 
``global.devMode``                                 dev mode for debugging with nexus, postgres and nginx                                                ``false``                                         
``global.postgres.repository``                     postgres repository name                                                                             ``"graphistry-postgres"``                         
``global.postgres.name``                           postgres db name                                                                                     ``"graphistry"``                                  
``global.postgres.user``                           postgres db user                                                                                     ``"graphistry"``                                  
``global.postgres.port``                           port for postgres service to listen on                                                               ``5432``                                          
``global.postgres.host``                           hostname for postgres                                                                                ``"postgres"``                                    
``global.tag``                                     tag for the docker image                                                                             ``"latest"``                                      
``global.imagePullPolicy``                         image pull policy could also be Always                                                               ``"IfNotPresent"``                                
``global.restartPolicy``                           restart policy                                                                                       ``"Always"``                                      
``global.imagePullSecrets``                        image pull secrets name                                                                              ``[]``                                            
``global.nodeSelector``                            node selector to determine which node to deploy cluster to                                           ``null``                                          
``global.logs.LogLevel``                                                                                                                                ``"INFO"``                                        
``global.logs.GraphistryLogLevel``                                                                                                                      ``"INFO"``                                        
``global.postgresVolumeLabel``                     postgres volume label                                                                                ``null``                                          
================================================== ==================================================================================================== ==================================================

The following table lists the configurable parameters of the Postgres cluster and their default values.  These settings control various aspects of the Postgres cluster, including storage, replication, backups, and resource allocation.

For ``postgresCluster.instance1.*`` (e.g. ``postgresCluster.instance1.dataVolumeClaimSpec.resources.requests.storage``):

==================================================== ========================================== ==========
Parameter                                            Description                                Default
==================================================== ========================================== ==========
``.dataVolumeClaimSpec.resources.requests.storage``  Storage request for the Postgres instance. ``10Gi``                                       
==================================================== ========================================== ==========

For ``postgresCluster.patroni.*`` (e.g. ``postgresCluster.patroni.dynamicConfiguration.postgresql.pg_hba``):

=========================================== ========================================================= ======================================
Parameter                                   Description                                               Default
=========================================== ========================================================= ======================================
``.dynamicConfiguration.postgresql.pg_hba`` List of PostgreSQL `pg_hba` entries for auth/replication. ``host all all 0.0.0.0/0 trust``
                                                                                                      ``host all postgres 127.0.0.1/32 md5``
=========================================== ========================================================= ======================================

For ``backups.pgbackrest.*`` (e.g. ``backups.pgbackrest.global.repo1-bundle-size``):

================================================================== ================================================= ==================
Parameter                                                          Description                                       Default
================================================================== ================================================= ==================
``.global.repo1-bundle-size``                                      Maximum size for each backup bundle.              ``1G``
``.global.repo1-bundle-limit``                                     Limit on the number of backup bundles to keep.    ``15``
``.global.repo1-retention-full``                                   Retention policy for full backups.                ``5``
``.global.repo1-retention-archive``                                Retention policy for archive logs.                ``10``
``.global.repo1-retention-diff``                                   Retention policy for differential backups.        ``7``
``.repoHost.resources.requests.cpu``                               CPU request for the backup repository host.       ``200m``
``.repoHost.resources.requests.memory``                            Memory request for the backup repository host.    ``256Mi``
``.repoHost.resources.limits.cpu``                                 CPU limit for the backup repository host.         ``200m``
``.repoHost.resources.limits.memory``                              Memory limit for the backup repository host.      ``256Mi``
``.sidecars.pgbackrest.resources.requests.cpu``                    CPU request for the pgbackrest sidecar.           ``100m``
``.sidecars.pgbackrest.resources.requests.memory``                 Memory request for the pgbackrest sidecar.        ``128Mi``
``.sidecars.pgbackrest.resources.limits.cpu``                      CPU limit for the pgbackrest sidecar.             ``100m``
``.sidecars.pgbackrest.resources.limits.memory``                   Memory limit for the pgbackrest sidecar.          ``128Mi``
``.sidecars.pgbackrestConfig.resources.requests.cpu``              CPU request for the pgbackrest config sidecar.    ``200m``
``.sidecars.pgbackrestConfig.resources.requests.memory``           Memory request for the pgbackrest config sidecar. ``128Mi``
``.sidecars.pgbackrestConfig.resources.limits.cpu``                CPU limit for the pgbackrest config sidecar.      ``200m``
``.sidecars.pgbackrestConfig.resources.limits.memory``             Memory limit for the pgbackrest config sidecar.   ``128Mi``
``.jobs.resources.requests.cpu``                                   CPU request for the backup jobs.                  ``200m``
``.jobs.resources.requests.memory``                                Memory request for the backup jobs.               ``128Mi``
``.jobs.resources.limits.cpu``                                     CPU limit for the backup jobs.                    ``200m``
``.jobs.resources.limits.memory``                                  Memory limit for the backup jobs.                 ``128Mi``
``.restore.repoName``                                              The repository name to use for restores.          ``repo1``
``.restore.enabled``                                               Enable or disable restore functionality.          ``false``
``.restore.resources.requests.cpu``                                CPU request for the restore job.                  ``100m``
``.restore.resources.requests.memory``                             Memory request for the restore job.               ``128Mi``
``.restore.resources.limits.cpu``                                  CPU limit for the restore job.                    ``100m``
``.restore.resources.limits.memory``                               Memory limit for the restore job.                 ``128Mi``
``.repos.repo1.schedule.full``                                     Full backup schedule (Cron expression).           ``"0 1 * * 0"``
``.repos.repo1.schedule.differential``                             Differential backup schedule (Cron expression).   ``"0 3 * * *"``
``.repos.repo1.schedule.incremental``                              Incremental backup schedule (Cron expression).    ``"*/30 * * * *"``
``.repos.repo1.volume.volumeClaimSpec.resources.requests.storage`` Storage request for backup volume.                ``50Gi``
================================================================== ================================================= ==================

For more information on the CrunchyData Postgres Cluster visit the PGO documentation: `CrunchyData PGO Documentation <https://access.crunchydata.com/documentation/postgres-operator/latest/>`_ 
